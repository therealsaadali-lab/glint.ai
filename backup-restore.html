<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>GLINT — Data Management</title>
  
  <link rel="stylesheet" href="theme.css" />
  <link rel="stylesheet" href="style.css" />
</head>
<body class="data-page"> 
  <header>
    <div class="brand">
      <div>
        <div class="title">GLINT</div>
        <div class="subtitle">Powered by AI • Data Management</div>
      </div>
    </div>
    <div>
      <button class="menu-btn" id="openDrawer">≡</button>
    </div>
  </header>
  <div class="overlay" id="drawerOverlay"></div>
  
  <div class="drawer" id="drawer">
    <a href="index.html" id="newChatBtn">✨ New Chat</a>
    <div style="height: 10px;"></div>
    
    <a href="save-messages.html" id="savedChatsLink">💾 Saved Conversations</a>
    <div style="height: 10px;"></div>
    <a href="new-project.html" id="newProjectLink">🚀 New Project</a>
    <div style="height: 10px;"></div>
    <a href="#" id="minihubLink">⚙️ Minihub</a>
    <div id="minihubSubmenu" class="submenu">
      <div class="submenu-item"><a href="theme.html">🎨 Theme</a></div>
      <div class="submenu-item"><a href="settings.html">⚙ Settings</a></div>
      <div class="submenu-item"><a href="privacy.html">🔒 Privacy</a></div>
      <div class="submenu-item"><a href="voice.html">🎤 Voice</a></div>
      <div class="submenu-item"><a href="language-selection.html">🌐 Language Selection</a></div>
    </div>
    <div style="height: 10px;"></div>
    <a href="#" id="supportLink">🤝 Support</a>
    <div id="supportSubmenu" class="submenu">
      <div class="submenu-item"><a href="send-feedback.html">📝 Send Feedback</a></div>
      <div class="submenu-item"><a href="share-app.html">🔗 Share this App</a></div>
    </div>
    <div style="height: 10px;"></div>
    <a href="#" id="toolsLink">🛠️ Tools</a>
    <div id="toolsSubmenu" class="submenu">
      <div class="submenu-item"><a href="backup-restore.html">💾 Backup & Restore</a></div>
      <div class="submenu-item"><a href="clear.html">🧹 Clear Data</a></div>
      <div class="submenu-item"><a href="export.html">📤 Export Chat</a></div>
    </div>
    <div style="height: 10px;"></div>
    <a href="#" id="infoLink">ℹ Info</a>
    <div id="infoSubmenu" class="submenu">
      <div class="submenu-item"><a href="about.html">ℹ About</a></div>
    </div>
  </div>
  <div class="container">
    <div class="content">
      <h1>💾 Data Backup & Restoration</h1>
      <p class="description">Safeguard your GLINT conversations and settings with our robust data management system. Create backups for security and seamless device migration.</p>

      <div class="backup-restore-section">
        <div class="backup-section section-card">
          <h2>📥 Create Backup</h2>
          <div class="option-group">
            <label for="backupType">Backup Scope:</label>
            <select id="backupType" class="small-btn theme-input">
              <option value="full">Full System Snapshot</option>
              <option value="conversations">Chat History Only</option>
              <option value="settings">User Settings Only</option>
              <option value="custom">Custom Selection</option>
            </select>
          </div>
          
          <div class="option-group custom-selection" style="display: none;">
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="includeChats" checked> Include **Conversations**
            </label>
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="includeSettings" checked> Include **App Settings**
            </label>
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="includeThemes" checked> Include **Theme Preferences**
            </label>
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="includeSaved" checked> Include **Saved Messages**
            </label>
          </div>
          
          <div class="option-group">
            <label for="backupFormat">File Format:</label>
            <select id="backupFormat" class="small-btn theme-input">
              <option value="json">JSON (Recommended)</option>
              <option value="encrypted">Encrypted JSON (Secure)</option>
              <option value="compressed">Compressed Archive (Optimized)</option>
            </select>
          </div>
          
          <div class="option-group">
            <label for="backupLocation">Storage Location:</label>
            <select id="backupLocation" class="small-btn theme-input">
              <option value="local">Local Download (On-Device)</option>
              <option value="cloud" disabled>Cloud Sync (Coming Soon)</option>
            </select>
          </div>
          
          <div class="option-group">
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="autoBackup"> Enable **Weekly Automatic Backups**
            </label>
          </div>
          
          <button class="export-btn btn-backup" id="createBackupBtn">💾 Initiate Backup</button>
        </div>

        <div class="restore-section section-card">
          <h2>📤 Restore Data</h2>
          <div class="option-group">
            <label for="restoreFile">Select Backup File (.json or .glintbak):</label>
            <input type="file" id="restoreFile" accept=".json,.glintbak" class="small-btn theme-input-file">
          </div>
          
          <div class="option-group">
            <label for="restoreScope">Restoration Mode:</label>
            <select id="restoreScope" class="small-btn theme-input">
              <option value="full">Full Overwrite</option>
              <option value="merge">Merge with Current Data</option>
              <option value="conversations">Conversations Only</option>
              <option value="settings">Settings Only</option>
            </select>
          </div>
          
          <div class="option-group">
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="backupBeforeRestore"> **Safety Check:** Backup Current Data First
            </label>
          </div>
          
          <div class="option-group">
            <label class="small-btn custom-checkbox theme-checkbox-label">
              <input type="checkbox" id="verifyIntegrity"> **Integrity Check:** Verify File Validity
            </label>
          </div>
          
          <button class="export-btn btn-restore" id="restoreBtn" disabled>🔄 Finalize Restore</button>
        </div>
      </div>

      <div class="details-section">
        <h2>📊 Backup History</h2>
        <div class="backup-history theme-history-box">
          <div class="no-backups" id="noBackups">No backups created yet.</div>
          <div id="backupList" class="backup-list"></div>
        </div>
      </div>

      <div class="details-section">
        <h2>✅ Core Backup Capabilities</h2>
        <ul class="professional-list">
          <li>**Granular Control:** Selectively backup chat, settings, or saved items.</li>
          <li>**Encryption Standard:** AES-256 for secure local storage of sensitive data.</li>
          <li>**Automated Scheduling:** Set and forget weekly data snapshots for peace of mind.</li>
          <li>**Data Portability:** Seamless migration of user data across different devices and platforms.</li>
        </ul>
      </div>

      <div class="details-section">
        <h2>🛠️ Advanced Restoration Modes</h2>
        <ul class="professional-list">
          <li>**Full Overwrite:** Completely replace all local data with the backup file contents.</li>
          <li>**Intelligent Merge:** Safely combine new conversations from the backup with your existing chat history.</li>
          <li>**Safety Protocol:** Automatically triggers a quick backup of current data before commencing any restoration.</li>
          <li>**Checksum Verification:** Ensures the backup file is not corrupted before attempting a restore operation.</li>
        </ul>
      </div>
      
      <div class="details-section">
        <h2>🔒 Security & Compliance</h2>
        <ul class="professional-list">
          <li>**Local Processing:** All backup/restore operations occur **on-device**; no data is sent to AI servers.</li>
          <li>**Zero-Knowledge Encryption:** Encryption keys are never transmitted, maintaining user privacy.</li>
          <li>**GDPR/CCPA Readiness:** Gives users full control to manage and export their personal data on demand.</li>
        </ul>
      </div>

      <div class="details-section">
        <h2>ℹ️ System Requirements</h2>
        <ul class="professional-list">
          <li>Modern browser with `localStorage` support.</li>
          <li>Minimum 50MB free space for backup operations.</li>
          <li>JavaScript enabled for core application features.</li>
        </ul>
      </div>
    </div>
  </div>

  <script src="theme.js"></script>
  <script src="script.js"></script>

  <script>
    // === Core Data Functions (Fixed for Glint Sync) ===
    function getAllConversations() {
      const conversations = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        // ✅ FIXED: Use 'messages_html_' to match script.js
        if (key.startsWith('messages_html_')) {
          conversations[key] = localStorage.getItem(key);
        }
      }
      return conversations;
    }

    function getAllSettings() {
      const settings = {};
      const settingKeys = ['theme', 'selectedLanguage', 'voiceSettings', 'currentConversationId', 'glintSavedMessages', 'glintBackups', 'glintSettings'];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (settingKeys.includes(key) || key.startsWith('setting_')) {
          settings[key] = localStorage.getItem(key);
        }
      }
      return settings;
    }

    function saveBackupInfo(backupData) {
      const backups = JSON.parse(localStorage.getItem('glintBackups') || '[]');
      if (backupData.type === 'safety_quick_backup') return; 
      
      backups.push({
        timestamp: backupData.timestamp,
        type: backupData.type,
        size: JSON.stringify(backupData).length,
        items: Object.keys(backupData.data).length
      });
      localStorage.setItem('glintBackups', JSON.stringify(backups));
    }

    function loadBackupHistory() {
      const backups = JSON.parse(localStorage.getItem('glintBackups') || '[]');
      const backupList = document.getElementById('backupList');
      const noBackups = document.getElementById('noBackups');

      if (backups.length === 0) {
        noBackups.style.display = 'block';
        backupList.innerHTML = '';
        return;
      }

      noBackups.style.display = 'none';
      backupList.innerHTML = backups.reverse().map(backup => {
        const date = new Date(backup.timestamp).toLocaleString();
        const sizeKB = (backup.size / 1024).toFixed(2);
        return `
          <div class="backup-item">
            <div class="backup-info">
              <strong>${date}</strong>
              <span class="backup-meta">Type: ${backup.type.replace(/_/g, ' ')} | Items: ${backup.items} | Size: ${sizeKB} KB</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function verifyBackupIntegrity(backupData) {
      return backupData && 
             backupData.version && 
             backupData.timestamp && 
             backupData.data && 
             typeof backupData.data === 'object';
    }

    function createQuickBackup() {
      const quickBackup = {
        version: '1.0',
        timestamp: new Date().toISOString(),
        type: 'safety_quick_backup',
        data: {
          conversations: getAllConversations(),
          settings: getAllSettings(),
          theme: localStorage.getItem('theme'),
          savedMessages: JSON.parse(localStorage.getItem("glintSavedMessages") || "[]")
        }
      };
      localStorage.setItem('glintSafetyBackup', JSON.stringify(quickBackup));
    }

    function restoreBackupData(backupData, scope) {
      if (scope === 'full') {
         for (let i = localStorage.length - 1; i >= 0; i--) {
             const key = localStorage.key(i);
             // ✅ FIXED: Use 'messages_html_'
             if (key.startsWith('messages_html_') || key.startsWith('glint') || key.startsWith('setting_') || 
                 key === 'theme' || key === 'selectedLanguage' || key === 'voiceSettings') {
                 localStorage.removeItem(key);
             }
         }
      }

      if (backupData.data.conversations && (scope === 'full' || scope === 'conversations' || scope === 'merge')) {
          Object.keys(backupData.data.conversations).forEach(key => {
            // ✅ FIXED: Use 'messages_html_'
            if (key.startsWith('messages_html_')) {
                if (scope === 'merge') {
                    const existing = localStorage.getItem(key);
                    if (!existing) { 
                        localStorage.setItem(key, backupData.data.conversations[key]);
                    }
                } else {
                    localStorage.setItem(key, backupData.data.conversations[key]);
                }
            }
          });
      }

      if (backupData.data.settings && (scope === 'full' || scope === 'settings' || scope === 'merge')) {
          Object.keys(backupData.data.settings).forEach(key => {
            if (key !== 'glintBackups' || scope === 'full') {
                localStorage.setItem(key, backupData.data.settings[key]);
            }
          });
      }

      if (backupData.data.theme) {
          localStorage.setItem('theme', backupData.data.theme);
      }
      if (backupData.data.savedMessages) {
          localStorage.setItem('glintSavedMessages', JSON.stringify(backupData.data.savedMessages));
      }
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      const savedTheme = localStorage.getItem('theme') || 'default';
      if (window.applyTheme) {
        window.applyTheme(savedTheme);
      } else {
        const themes = {
          default: { bg: '#ffffff', text: '#111111', panel: '#f2f2f2', card: '#eaeaea', accent: '#60A5FA', accent2: '#6EE7B7', 'bot-text': '#ffffff', 'border': '#dddddd' },
          dark: { bg: '#1a1a1a', text: '#ffffff', panel: '#2a2a2a', card: '#333333', accent: '#4A90E2', accent2: '#34C759', 'bot-text': '#ffffff', 'border': '#444444' }
        };
        const theme = themes[savedTheme] || themes.default;
        const root = document.documentElement;
        for (const [key, value] of Object.entries(theme)) {
            root.style.setProperty(`--${key}`, value);
        }
      }
      
      const backupType = document.getElementById('backupType');
      const customSelection = document.querySelector('.custom-selection');
      const createBackupBtn = document.getElementById('createBackupBtn');
      const restoreFile = document.getElementById('restoreFile');
      const restoreBtn = document.getElementById('restoreBtn');
      
      loadBackupHistory();

      backupType.addEventListener('change', function() {
        customSelection.style.display = this.value === 'custom' ? 'block' : 'none';
      });

      restoreFile.addEventListener('change', function() {
        restoreBtn.disabled = !this.files.length;
      });

      createBackupBtn.addEventListener('click', function() {
        const type = backupType.value;
        const format = document.getElementById('backupFormat').value;
        const location = document.getElementById('backupLocation').value;
        
        let includeChats = true, includeSettings = true, includeThemes = true, includeSaved = true;
        if (type === 'custom') {
          includeChats = document.getElementById('includeChats').checked;
          includeSettings = document.getElementById('includeSettings').checked;
          includeThemes = document.getElementById('includeThemes').checked;
          includeSaved = document.getElementById('includeSaved').checked;
        } else if (type === 'conversations') {
            includeSettings = false; includeThemes = false; includeSaved = false;
        } else if (type === 'settings') {
            includeChats = false; includeSaved = false;
        }

        const backupData = {
          version: '1.0',
          timestamp: new Date().toISOString(),
          type: type,
          format: format,
          data: {}
        };

        if (includeChats) backupData.data.conversations = getAllConversations();
        if (includeSettings) backupData.data.settings = getAllSettings();
        if (includeThemes) backupData.data.theme = localStorage.getItem('theme');
        if (includeSaved) backupData.data.savedMessages = JSON.parse(localStorage.getItem("glintSavedMessages") || "[]");
        
        if (type === 'settings' && backupData.data.settings) {
            delete backupData.data.settings.glintBackups;
            delete backupData.data.settings.glintSafetyBackup;
            delete backupData.data.settings.glintSavedMessages;
            Object.keys(backupData.data.settings).forEach(key => {
                // ✅ FIXED: Use 'messages_html_'
                if (key.startsWith('messages_html_')) delete backupData.data.settings[key];
            });
        }

        if (location === 'local') {
          const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `glint_backup_${new Date().toISOString().split('T')[0]}_${type}.json`;
          a.click();
          URL.revokeObjectURL(url);
        }

        saveBackupInfo(backupData);
        loadBackupHistory();
        alert('Backup created successfully! File downloaded locally.');
      });

      restoreBtn.addEventListener('click', function() {
        const file = restoreFile.files[0];
        const scope = document.getElementById('restoreScope').value;
        const backupBefore = document.getElementById('backupBeforeRestore').checked;
        const verifyIntegrity = document.getElementById('verifyIntegrity').checked;

        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
          try {
            const backupData = JSON.parse(e.target.result);
            if (verifyIntegrity && !verifyBackupIntegrity(backupData)) {
              alert('Backup file integrity check failed. File may be corrupted.');
              return;
            }
            if (backupBefore) {
              createQuickBackup();
            }
            restoreBackupData(backupData, scope);
            alert('Data restored successfully! Page will reload.');
            setTimeout(() => location.reload(), 1000); 
          } catch (error) {
            alert('Error restoring backup. File format or content invalid.');
          }
        };
        reader.readAsText(file);
      });
    });
  </script>

  <style>
    .menu-btn {
      color: var(--text) !important;
      background: transparent !important;
      border: none !important;
      font-size: 28px;
      line-height: 1;
      padding: 0 5px;
      cursor: pointer;
    }
    header {
      background: var(--panel) !important;
      border-bottom: 1px solid var(--border) !important;
    }
    header .brand .title, header .brand .subtitle {
      color: var(--text) !important; 
    }
    
    body {
        font-family: Inter, Arial; 
        font-size: 16px; 
        line-height: 1.6;
        background: var(--bg) !important;
        color: var(--text) !important;
        margin: 0;
        padding: 0;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        transition: all 0.3s ease;
    }
    
    .container {
        flex: 1;
        display: flex;
        justify-content: center;
        width: 100%;
        margin: 0;
        padding: 20px 0;
    }
    
    .content {
        max-width: 800px;
        width: 100%;
        padding: 15px;
        background: var(--bg) !important;
        color: var(--text) !important;
    }

    h1 { 
        font-size: 2em; 
        font-weight: 700;
        color: var(--accent) !important;
        text-align: center;
        margin-bottom: 10px;
    } 
    h2 { 
        font-size: 1.5em; 
        font-weight: 600;
        color: var(--text) !important;
        border-bottom: 2px solid var(--border) !important;
        padding-bottom: 5px;
        margin-top: 25px; 
        margin-bottom: 15px; 
    } 
    
    .description {
        font-size: 1em;
        text-align: center;
        opacity: 0.8;
        margin-bottom: 30px;
    }

    .backup-restore-section {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }

    .section-card {
        flex: 1;
        background: var(--card) !important;
        border: 1px solid var(--border) !important;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    }
    
    .option-group {
        margin-bottom: 15px;
    }

    .option-group label {
        font-weight: 500;
        display: block;
        margin-bottom: 8px;
        color: var(--text) !important;
    }

    .small-btn,
    .theme-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--border) !important;
        border-radius: 6px;
        background: var(--panel) !important;
        color: var(--text) !important;
        font-size: 1em;
        appearance: none;
    }
    
    .theme-input-file {
        padding: 10px 0;
        border: none !important;
        background: transparent !important;
    }
    
    .custom-checkbox {
        display: block;
        margin-top: 5px;
        user-select: none;
        cursor: pointer;
    }
    
    .custom-checkbox input[type="checkbox"] {
        margin-right: 8px;
        transform: scale(1.1);
    }

    .export-btn {
        width: 100%;
        padding: 12px 15px;
        font-size: 1em;
        font-weight: 600;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        margin-top: 10px;
        color: var(--bot-text) !important;
    }
    
    .btn-backup {
        background: var(--accent) !important;
    }
    .btn-backup:hover {
        background: var(--accent2) !important;
    }

    .btn-restore {
        background: var(--accent) !important;
    }
    .btn-restore:hover:not(:disabled) {
        background: var(--accent2) !important;
    }
    .btn-restore:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .details-section {
        margin-top: 30px;
    }

    .professional-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .professional-list li {
        padding: 10px 15px;
        margin: 8px 0;
        background: var(--panel) !important;
        border: 1px solid var(--border) !important;
        border-left: 4px solid var(--accent) !important;
        border-radius: 6px;
        font-size: 1em;
    }

    .backup-history {
        min-height: 100px;
        background: var(--card) !important;
        border: 1px solid var(--border) !important;
        border-radius: 8px;
        padding: 15px;
    }
    
    .backup-item {
        padding: 10px 0;
        border-bottom: 1px dashed var(--border);
    }
    .backup-item:last-child {
        border-bottom: none;
    }
    
    .backup-info strong {
        font-weight: 600;
        display: block;
        margin-bottom: 4px;
    }
    
    .backup-meta {
        font-size: 0.9em;
        opacity: 0.7;
        display: block;
    }
    
    .no-backups {
        text-align: center;
        padding: 30px;
        opacity: 0.6;
    }

    .drawer {
        background-color: var(--panel) !important;
        color: var(--text) !important;
    }

    .drawer a {
        color: var(--text) !important;
    }

    .submenu {
        background-color: var(--card) !important;
        border: 1px solid var(--border) !important;
    }

    .submenu-item a {
        color: var(--text) !important;
    }

    @media (max-width: 768px) {
        .backup-restore-section {
            flex-direction: column;
            gap: 15px;
        }
        
        .content {
            padding: 10px;
        }
        
        h1 { font-size: 1.5em; }
        h2 { font-size: 1.3em; }
        
        .section-card {
            padding: 15px;
        }
        
        .export-btn {
            padding: 10px;
            font-size: 0.9em;
        }
        
        .professional-list li, .backup-meta, .description {
            font-size: 0.9em;
        }
    }
  </style>
</body>
</html>